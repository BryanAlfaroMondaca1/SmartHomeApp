#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <WiFiClientSecure.h>
#include <ArduinoJson.h>
#include <DHT.h>

// --- CONFIGURACIÓN DE RED Y FIREBASE ---
const char* WIFI_SSID = "4br";
const char* WIFI_PASSWORD = "12345678";
const char* FIREBASE_HOST = "smarthomeapp-8e5ac-default-rtdb.firebaseio.com";
const char* FIREBASE_AUTH = "wE8DDsoJpgAVFR40hdfFIpC3SbUis2LhXyZNSbtm";

// --- DEFINICIÓN DE PINES ---
#define DHTPIN      D4
#define LDR_PIN     A0
#define RELE_PIN    D5 // Ventilador
#define LED_PIN     D1 // Luces
#define BUZZER_PIN  D2 // Alarma

// --- OBJETOS ---
WiFiClientSecure client;
DHT dht(DHTPIN, DHT11);

// --- VARIABLES GLOBALES ---
unsigned long lastSendTime = 0;
unsigned long lastReadTime = 0;
const unsigned long sendInterval = 5000; // Enviar datos de sensores cada 5 segundos
const unsigned long readInterval = 2000; // Leer controles cada 2 segundos

// ==================== SETUP ====================
void setup() {
  Serial.begin(115200);
  Serial.println("\n========================================");
  Serial.println("        SISTEMA DE SENSORES Y CONTROL IoT         ");
  Serial.println("========================================");

  dht.begin();
  pinMode(LDR_PIN, INPUT);
  pinMode(RELE_PIN, OUTPUT);
  pinMode(LED_PIN, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);

  digitalWrite(RELE_PIN, LOW);
  digitalWrite(LED_PIN, LOW);
  digitalWrite(BUZZER_PIN, LOW);

  conectarWiFi();

  client.setInsecure();
  client.setBufferSizes(1024, 512);

  Serial.println("\n========================================");
  Serial.println("          SISTEMA LISTO");
  Serial.println("========================================\n");
}

// ==================== LOOP PRINCIPAL ====================
void loop() {
  unsigned long currentTime = millis();

  if (WiFi.status() != WL_CONNECTED) {
    conectarWiFi();
  }

  if (currentTime - lastSendTime >= sendInterval) {
    enviarSensoresFirebase();
    lastSendTime = currentTime;
  }

  if (currentTime - lastReadTime >= readInterval) {
    leerControlesFirebase();
    lastReadTime = currentTime;
  }

  delay(10);
}

// ==================== FUNCIONES WIFI ====================
void conectarWiFi() {
  Serial.print("Conectando a WiFi: ");
  Serial.print(WIFI_SSID);
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi Conectado!");
  Serial.print("Dirección IP: ");
  Serial.println(WiFi.localIP());
}

// ==================== FUNCIONES FIREBASE ====================
void leerControlesFirebase() {
  String url = "https://" + String(FIREBASE_HOST) + "/controls.json";
  String payload;

  if (getHttpRequest(url, payload)) {
    StaticJsonBuffer<200> jsonBuffer;
    JsonObject& root = jsonBuffer.parseObject(payload);

    if (!root.success()) {
      Serial.println("Error al parsear JSON de controles.");
      return;
    }

    bool fanOn = root["fan"];
    bool lightsOn = root["lights"];
    bool alarmOn = root["alarm"];

    digitalWrite(RELE_PIN, fanOn ? HIGH : LOW);
    digitalWrite(LED_PIN, lightsOn ? HIGH : LOW);
    digitalWrite(BUZZER_PIN, alarmOn ? HIGH : LOW);
    
    Serial.println("Controles actualizados desde Firebase.");
  }
}

void enviarSensoresFirebase() {
  float temperatura = dht.readTemperature();
  float humedad = dht.readHumidity();
  int luz = analogRead(LDR_PIN);

  if (isnan(temperatura) || isnan(humedad)) {
    Serial.println("Error al leer el sensor DHT11.");
    return;
  }

  StaticJsonBuffer<200> jsonBuffer;
  JsonObject& root = jsonBuffer.createObject();
  root["temperatura"] = temperatura;
  root["humedad"] = humedad;
  root["luz"] = luz;

  String jsonData;
  root.printTo(jsonData);

  String url = "https://" + String(FIREBASE_HOST) + "/sensores.json";

  if (sendHttpRequest("PUT", url, jsonData)) {
    Serial.println("Datos de sensores enviados a Firebase.");
  } else {
    Serial.println("Error al enviar datos de sensores.");
  }
}

bool getHttpRequest(String url, String& payload) {
    HTTPClient https;
    if (strlen(FIREBASE_AUTH) > 0) {
        url += "?auth=" + String(FIREBASE_AUTH);
    }

    if (https.begin(client, url)) {
        int httpCode = https.GET();
        if (httpCode == HTTP_CODE_OK) {
            payload = https.getString();
            https.end();
            return true;
        }
        Serial.printf("[HTTPS] GET... falló, código de error: %d\n", httpCode);
        https.end();
    }
    return false;
}

bool sendHttpRequest(String method, String url, String payload) {
  HTTPClient https;
  if (strlen(FIREBASE_AUTH) > 0) {
    url += "?auth=" + String(FIREBASE_AUTH);
  }

  if (https.begin(client, url)) {
    https.addHeader("Content-Type", "application/json");
    int httpCode = https.PUT(payload);

    if (httpCode == HTTP_CODE_OK) {
        https.end();
        return true;
    }
    Serial.printf("[HTTPS] PUT... falló, código de error: %d\n", httpCode);
    https.end();
  }
  return false;
}
