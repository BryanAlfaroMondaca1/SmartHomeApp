#include <DHT.h>
#include <ESP8266WiFi.h>

#define DHTPIN D4
#define DHTTYPE DHT11
#define LDR_PIN A0
#define LED_PIN D1
#define LED_OSCURIDAD_PIN D3
#define BUZZER_PIN D2
#define RELE_PIN D5

//  SEGURIDAD 
const char* ssid = "4br";        
const char* password = "12345678";   
const String passwordWeb = "1234";    
#define TEMP_ALTA 5.50
#define TEMP_CONFORT 0.10  
#define LUZ_OSCURA 500

DHT dht(DHTPIN, DHTTYPE);
WiFiServer server(80);

bool modoManual = false;
bool ledManual = false;
bool buzzerManual = false;
bool releManual = false;
bool autenticado = false;  // NUEVO: Control de acceso

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println();
  Serial.println("SISTEMA INICIANDO...");
  
  pinMode(LED_PIN, OUTPUT);
  pinMode(LED_OSCURIDAD_PIN, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(RELE_PIN, OUTPUT);
  
  digitalWrite(LED_PIN, LOW);
  digitalWrite(LED_OSCURIDAD_PIN, LOW);
  digitalWrite(BUZZER_PIN, LOW);
  digitalWrite(RELE_PIN, LOW);
  
  dht.begin();
  
  // Conexi칩n WiFi
  Serial.print("Conectando WiFi");
  WiFi.begin(ssid, password);
  
  unsigned long startTime = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - startTime < 10000) {
    delay(500);
    Serial.print(".");
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println();
    Serial.print("WiFi Conectado - IP: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println();
    Serial.println("WiFi Fallo - Modo offline");
  }
  
  server.begin();
  Serial.println("Servidor web LISTO");
  Serial.println("========================");
}

void loop() {
  float temperatura = dht.readTemperature();
  int valorLuz = analogRead(LDR_PIN);
  
  // Control LED oscuridad
  if (valorLuz < LUZ_OSCURA) {
    digitalWrite(LED_OSCURIDAD_PIN, LOW);
    Serial.println("LED ILUMINACION ENCENDIDO (oscuridad detectada)");
  } else {
    digitalWrite(LED_OSCURIDAD_PIN, HIGH);
    Serial.println("LED ILUMINACION APAGADO (suficiente luz)");
  }
  
  // Control AUTOMATICO solo si la lectura es v치lida
  if (!isnan(temperatura)) {
    if (!modoManual) {
      if (temperatura >= TEMP_ALTA) {
        digitalWrite(LED_PIN, HIGH);
        digitalWrite(BUZZER_PIN, HIGH);
        digitalWrite(RELE_PIN, HIGH);
        Serial.println("ALTA TEMP - Rele: ON ");
      } 
      else if (temperatura >= TEMP_CONFORT) {
        digitalWrite(LED_PIN, HIGH);
        digitalWrite(BUZZER_PIN, LOW);
        digitalWrite(RELE_PIN, LOW);
        Serial.println("TEMP CONFORT - Rele: OFF");
      }
      else {
        digitalWrite(LED_PIN, LOW);
        digitalWrite(BUZZER_PIN, LOW);
        digitalWrite(RELE_PIN, LOW);
        Serial.println("TEMP BAJA - Rele: OFF");
      }
    }
    
    // Mostrar datos
    Serial.print("Temp: ");
    Serial.print(temperatura);
    Serial.print("춿C | Luz: ");
    Serial.print(valorLuz);
    Serial.print(" | Rele: ");
    Serial.println(digitalRead(RELE_PIN) ? "ON" : "OFF");
    
  } else {
    Serial.println("Error sensor temp - Modo seguro");
    digitalWrite(RELE_PIN, LOW);
  }
  
  // Servidor Web con SEGURIDAD
  WiFiClient client = server.available();
  if (client) {
    Serial.println("Cliente web conectado");
    
    String request = client.readStringUntil('\r');
    Serial.println("Request: " + request);
    
    // 游 SEGURIDAD: VERIFICAR ACCESO
    if (!autenticado) {
      if (request.indexOf("GET /login?pwd=") != -1) {
        // Verificar contrase침a
        if (request.indexOf(passwordWeb) != -1) {
          autenticado = true;
          Serial.println("USUARIO AUTENTICADO");
        }
      }
      
      // Mostrar p치gina de login
      client.println("HTTP/1.1 200 OK");
      client.println("Content-Type: text/html");
      client.println("Connection: close");
      client.println();
      client.println("<!DOCTYPE HTML>");
      client.println("<html><head><style>");
      client.println("body { font-family: Arial; text-align: center; margin: 50px; background: #f0f0f0; }");
      client.println("h1 { color: #333; } .login { background: white; padding: 30px; border-radius: 10px; margin: 20px auto; width: 300px; }");
      client.println("input, button { padding: 10px; margin: 5px; width: 80%; font-size: 16px; }");
      client.println("</style></head><body>");
      client.println("<h1>INGRESAR PASS</h1>");
      client.println("<div class='login'>");
      client.println("<h3>password</h3>");
      client.println("<form action='/login'>");
      client.println("<input type='password' name='pwd' placeholder='Contrase침a' required><br>");
      client.println("<button type='submit'>ACCEDER</button>");
      client.println("</form>");
      client.println("</div></body></html>");
      
      client.stop();
      Serial.println("游 P치gina de login mostrada");
      return;
    }
    
    // 游댑 SI EST츼 AUTENTICADO, PROCESAR COMANDOS
    // ANALIZAR LA PETICI칍N Y ACTUAR
    if (request.indexOf("GET /on") != -1) {
      digitalWrite(LED_PIN, HIGH);
      ledManual = true;
      modoManual = true;
      Serial.println("LED encendido manualmente");
    }
    else if (request.indexOf("GET /off") != -1) {
      digitalWrite(LED_PIN, LOW);
      ledManual = false;
      Serial.println("LED apagado manualmente");
    }
    else if (request.indexOf("GET /buzzon") != -1) {
      digitalWrite(BUZZER_PIN, HIGH);
      buzzerManual = true;
      modoManual = true;
      Serial.println(" BUZZER encendido manualmente");
    }
    else if (request.indexOf("GET /buzzoff") != -1) {
      digitalWrite(BUZZER_PIN, LOW);
      buzzerManual = false;
      Serial.println(" BUZZER apagado manualmente");
    }
    else if (request.indexOf("GET /releon") != -1) {
      digitalWrite(RELE_PIN, HIGH);
      releManual = true;
      modoManual = true;
      Serial.println(" RELEVADOR activado manualmente");
    }
    else if (request.indexOf("GET /releoff") != -1) {
      digitalWrite(RELE_PIN, LOW);
      releManual = false;
      Serial.println("RELEVADOR desactivado manualmente");
    }
    else if (request.indexOf("GET /auto") != -1) {
      modoManual = false;
      Serial.println(" Modo AUTOMATICO activado");
    }
    else if (request.indexOf("GET /logout") != -1) {
      autenticado = false;
      Serial.println("游 Usuario desconectado");
    }
    
    client.flush();
    
    // P치gina web HTML COMPLETA (usuarios autenticados)
    client.println("HTTP/1.1 200 OK");
    client.println("Content-Type: text/html");
    client.println("Connection: close");
    client.println();
    client.println("<!DOCTYPE HTML>");
    client.println("<html><head><meta name='viewport' content='width=device-width, initial-scale=1'>");
    client.println("<style>");
    client.println("body { font-family: Arial; text-align: center; margin: 20px; background: #f0f0f0; }");
    client.println("h1 { color: #333; } .data { font-size: 20px; margin: 20px; padding: 15px; background: white; border-radius: 10px; }");
    client.println("button { font-size: 18px; padding: 12px 25px; margin: 8px; border: none; border-radius: 5px; cursor: pointer; }");
    client.println(".auto { background-color: #4444ff; color: white; }");
    client.println(".on { background-color: #44ff44; } .off { background-color: #ff4444; }");
    client.println(".rele-on { color: red; font-weight: bold; } .rele-off { color: gray; }");
    client.println(".luz-on { color: blue; } .luz-off { color: green; }");
    client.println(".manual { background: #ffaa00; } .auto-btn { background: #4444ff; color: white; }");
    client.println(".logout { background: #ff4444; color: white; position: absolute; top: 10px; right: 10px; }");
    client.println("</style></head><body>");
    client.println("<a href='/logout'><button class='logout'>CERRAR SESION</button></a>");
    client.println("<h1>Control de Ambiente Automatico</h1>");
    
    // Mostrar datos y estado
    client.println("<div class='data'>");
    client.print("Temperatura: <b>"); client.print(temperatura); client.println("춿C</b>");
    client.print("<br> Luz: <b>"); client.print(valorLuz); client.println("</b>");
    
    // Estado del LED de ILUMINACION
    client.print("<br> Iluminacion: ");
    if (valorLuz < LUZ_OSCURA) {
      client.println("<span class='luz-on'><b>ACTIVA (oscuridad)</b></span>");
    } else {
      client.println("<span class='luz-off'><b>INACTIVA (luz)</b></span>");
    }
    
    // Estado del RELEVADOR
    client.print("<br> Relevador: ");
    if (digitalRead(RELE_PIN)) {
      client.println("<span class='rele-on'><b>ACTIVADO (ventilador ON)</b></span>");
    } else {
      client.println("<span class='rele-off'><b>DESACTIVADO (ventilador OFF)</b></span>");
    }
    
    client.print("<br>Modo: <b>"); client.print(modoManual ? "MANUAL" : "AUTOMaTICO"); client.println("</b>");
    client.println("</div>");
    
    // Botones de control COMPLETOS
    client.println("<h2>Control Manual:</h2>");
    client.println("<a href='/on'><button class='on'>ENCENDER LED</button></a>");
    client.println("<a href='/off'><button class='off'>APAGAR LED</button></a><br>");
    client.println("<a href='/buzzon'><button class='on'>ENCENDER BUZZER</button></a>");
    client.println("<a href='/buzzoff'><button class='off'>APAGAR BUZZER</button></a><br>");
    client.println("<a href='/releon'><button class='on'>ACTIVAR RELEVADOR</button></a>");
    client.println("<a href='/releoff'><button class='off'>DESACTIVAR RELEVADOR</button></a><br>");
    client.println("<a href='/auto'><button class='auto-btn'>MODO AUTOMATICO</button></a>");
    
    client.println("</body></html>");
    
    delay(1);
    client.stop();
    Serial.println("Cliente desconectado");
  }
  
  delay(2000);
}
