#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <WiFiClientSecure.h>
#include <ArduinoJson.h>
#include <DHT.h>

// --- CONFIGURACIÓN DE RED Y FIREBASE ---
const char* WIFI_SSID = "4br";
const char* WIFI_PASSWORD = "12345678";
const char* FIREBASE_HOST = "smarthomeapp-8e5ac-default-rtdb.firebaseio.com";
const char* FIREBASE_AUTH = "wE8DDsoJpgAVFR40hdfFIpC3SbUis2LhXyZNSbtm";

// --- DEFINICIÓN DE PINES ---
#define DHTPIN D4
#define DHTTYPE DHT11
#define LDR_PIN A0

// --- OBJETOS ---
WiFiClientSecure client;
DHT dht(DHTPIN, DHTTYPE);

// --- VARIABLES GLOBALES ---
unsigned long lastSendTime = 0;
const unsigned long sendInterval = 5000; // Enviar datos cada 5 segundos

// ==================== SETUP ====================
void setup() {
  Serial.begin(115200);
  Serial.println("\n========================================");
  Serial.println("        SISTEMA DE SENSORES IoT         ");
  Serial.println("========================================");

  dht.begin();
  pinMode(LDR_PIN, INPUT);

  conectarWiFi();

  // Necesario para peticiones HTTPS a Firebase
  client.setInsecure(); 
  client.setBufferSizes(1024, 512);

  Serial.println("\n========================================");
  Serial.println("          SISTEMA LISTO");
  Serial.println("========================================\n");
}

// ==================== LOOP PRINCIPAL ====================
void loop() {
  unsigned long currentTime = millis();

  // Reintentar conexión si se pierde
  if (WiFi.status() != WL_CONNECTED) {
    conectarWiFi();
  }

  // Enviar datos a Firebase cada `sendInterval` milisegundos
  if (currentTime - lastSendTime >= sendInterval) {
    enviarSensoresFirebase();
    lastSendTime = currentTime;
  }

  // Pequeña pausa para no saturar el procesador
  delay(10);
}

// ==================== FUNCIONES WIFI ====================
void conectarWiFi() {
  Serial.print("Conectando a WiFi: ");
  Serial.print(WIFI_SSID);

  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\nWiFi Conectado!");
  Serial.print("Dirección IP: ");
  Serial.println(WiFi.localIP());
}

// ==================== FUNCIONES FIREBASE ====================
void enviarSensoresFirebase() {
  // 1. Leer los sensores
  float temperatura = dht.readTemperature();
  int luz = analogRead(LDR_PIN);

  // Validar lectura de temperatura
  if (isnan(temperatura)) {
    Serial.println("Error al leer el sensor de temperatura.");
    return;
  }

  Serial.println("----------------------------------------");
  Serial.print("Lectura Actual -> ");
  Serial.print("Temperatura: ");
  Serial.print(temperatura);
  Serial.print("°C, Luz: ");
  Serial.println(luz);

  // 2. Preparar los datos en formato JSON (Compatible con ArduinoJson v5)
  StaticJsonBuffer<200> jsonBuffer;
  JsonObject& root = jsonBuffer.createObject();
  root["temperatura"] = temperatura;
  root["luz"] = luz;

  String jsonData;
  root.printTo(jsonData);

  // 3. Enviar los datos al nodo "/sensores" de Firebase
  String url = "https://" + String(FIREBASE_HOST) + "/sensores.json";

  if (sendHttpRequest("PUT", url, jsonData)) {
    Serial.println("-> Datos enviados a Firebase correctamente.");
  } else {
    Serial.println("-> Error al enviar datos a Firebase.");
  }
  Serial.println("----------------------------------------");
}

bool sendHttpRequest(String method, String url, String payload) {
  HTTPClient https;

  if (strlen(FIREBASE_AUTH) > 0) {
    url += "?auth=" + String(FIREBASE_AUTH);
  }

  if (https.begin(client, url)) {
    https.addHeader("Content-Type", "application/json");

    int httpCode;
    if (method == "PUT") {
      httpCode = https.PUT(payload);
    } else {
      // Se pueden agregar otros métodos como POST si es necesario
      httpCode = -1;
    }

    if (httpCode > 0) {
      if (httpCode == HTTP_CODE_OK || httpCode == HTTP_CODE_CREATED) {
        https.end();
        return true;
      } else {
        Serial.printf("[HTTPS] Falló, código de error: %d\n", httpCode);
      }
    } else {
      Serial.printf("[HTTPS] Error en la conexión: %s\n", https.errorToString(httpCode).c_str());
    }

    https.end();
  } else {
    Serial.println("[HTTPS] No se pudo iniciar la conexión.");
  }

  return false;
}
