#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <WiFiClientSecure.h> 
#include <ArduinoJson.h>
#include <DHT.h>
#include <WiFiManager.h>
#include <LittleFS.h>

// <--- MODO DE DEMOSTRACIÓN ---
#define MODO_DEMO true // Cambia a 'false' para usar los sensores reales

// --- CONFIGURACIÓN DE FIREBASE ---
const char* FIREBASE_HOST = "smarthomeapp-8e5ac-default-rtdb.firebaseio.com";
const char* FIREBASE_AUTH = "wE8DDsoJpgAVFR40hdfFIpC3SbUis2LhXyZNSbtm";

// --- DEFINICIÓN DE PINES ---
#define DHTPIN      D4
#define LDR_PIN     A0
#define RELE_PIN    D5
#define LED_PIN     D1
#define BUZZER_PIN  D2
#define LED_OSCURIDAD_PIN D6

// --- UMBRALES Y CONFIGURACIÓN ---
const int UMBRAL_OSCURIDAD = 500;
String modoOperacion = "manual";
double tempMax = 30.0;

// --- OBJETOS ---
WiFiClientSecure client;
DHT dht(DHTPIN, DHT11);

// --- VARIABLES DE TIEMPO ---
unsigned long lastSendTime = 0;
unsigned long lastReadTime = 0;
unsigned long lastConfigReadTime = 0;

const unsigned long sendInterval = 5000;
const unsigned long readInterval = 2000;
const unsigned long configReadInterval = 15000;

// ==================== SETUP ====================
void setup() {
  Serial.begin(115200);
  Serial.println("\n========================================");
  Serial.println("        SISTEMA DE SENSORES Y CONTROL IoT         ");
  Serial.println("========================================");

  if(!LittleFS.begin()){
    Serial.println("Error al montar LittleFS");
    return;
  }
  
dht.begin();
  pinMode(LDR_PIN, INPUT);
  pinMode(RELE_PIN, OUTPUT);
  pinMode(LED_PIN, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(LED_OSCURIDAD_PIN, OUTPUT);

  digitalWrite(RELE_PIN, LOW);
  digitalWrite(LED_PIN, LOW);
  digitalWrite(BUZZER_PIN, LOW);
  digitalWrite(LED_OSCURIDAD_PIN, LOW);
  
  WiFiManager wm;
  // wm.resetSettings();
  if(!wm.autoConnect("AutoComfort-Config")) {
      Serial.println("Fallo al conectar. Reiniciando...");
      delay(3000);
      ESP.restart();
  } 

  Serial.println("\nWiFi Conectado!");
  Serial.print("Dirección IP: ");
  Serial.println(WiFi.localIP());

  client.setInsecure();
  client.setBufferSizes(1024, 512);

  Serial.println("========================================");
  Serial.println("          SISTEMA LISTO");
  Serial.println("========================================\n");
}

// ==================== LOOP PRINCIPAL ====================
void loop() {
  unsigned long currentTime = millis();

  if (WiFi.status() == WL_CONNECTED) {
    procesarColaOffline();

    if (currentTime - lastConfigReadTime >= configReadInterval) {
      leerConfiguraciones();
    }

    if (currentTime - lastSendTime >= sendInterval) {
      enviarSensoresFirebase(true);
      lastSendTime = currentTime;
    }

    if (currentTime - lastReadTime >= readInterval) {
      leerControlesFirebase();
      lastReadTime = currentTime;
    }

  } else {
    if (currentTime - lastSendTime >= sendInterval) {
      enviarSensoresFirebase(false);
      lastSendTime = currentTime;
    }
  }

  controlarLuzAutomatica();
  delay(200);
}

// ==================== FUNCIONES DE CONTROL ====================
void controlarLuzAutomatica() {
  static int lastLuzState = -1; 
  int valorLuz = analogRead(LDR_PIN);
  int currentLuzState;

  if (valorLuz > UMBRAL_OSCURIDAD) {
    digitalWrite(LED_OSCURIDAD_PIN, LOW);
    currentLuzState = LOW;
  } else {
    digitalWrite(LED_OSCURIDAD_PIN, HIGH);
    currentLuzState = HIGH;
  }

  if (currentLuzState != lastLuzState) {
    lastLuzState = currentLuzState;
  }
}

void leerConfiguraciones(){
  String url = "https://" + String(FIREBASE_HOST) + "/device/settings.json";
  String payload;
  if (getHttpRequest(url, payload)) {
      StaticJsonBuffer<200> jsonBuffer;
      JsonObject& root = jsonBuffer.parseObject(payload);
      if (!root.success()) return;
      if(root.containsKey("mode")) modoOperacion = root["mode"].as<String>();
      if(root.containsKey("tempMax")) tempMax = root["tempMax"].as<double>();
  }
}

// ==================== FUNCIONES FIREBASE Y OFFLINE ====================
void enviarSensoresFirebase(bool enTiempoReal) {
  float temperatura;
  float humedad;
  int luz;

  if (MODO_DEMO) {
    // Generar datos simulados y realistas
    temperatura = 20.0 + (sin(millis() / 60000.0) * 10.0); // Varía suavemente entre 20 y 30 grados
    humedad = 55.0 + (cos(millis() / 30000.0) * 10.0); // Varía suavemente entre 45 y 65%
    luz = analogRead(LDR_PIN); // La luz sigue siendo real
  } else {
    // Leer sensores reales
    temperatura = dht.readTemperature();
    humedad = dht.readHumidity();
    luz = analogRead(LDR_PIN);
    if (isnan(temperatura) || isnan(humedad)) {
      Serial.println("Error al leer el sensor DHT11.");
      return;
    }
  }

  if (modoOperacion == "auto" && enTiempoReal) {
    bool activarAlarma = (temperatura > tempMax);
    digitalWrite(RELE_PIN, activarAlarma ? HIGH : LOW);
    digitalWrite(BUZZER_PIN, activarAlarma ? HIGH : LOW);

    String controlUrl = "https://" + String(FIREBASE_HOST) + "/controls.json";
    StaticJsonBuffer<200> controlJsonBuffer;
    JsonObject& controlRoot = controlJsonBuffer.createObject();
    controlRoot["fan"] = activarAlarma;
    controlRoot["alarm"] = activarAlarma;
    controlRoot["lights"] = digitalRead(LED_PIN) == HIGH;
    String controlData;
    controlRoot.printTo(controlData);
    sendHttpRequest("PUT", controlUrl, controlData);
  }

  StaticJsonBuffer<200> jsonBuffer;
  JsonObject& root = jsonBuffer.createObject();
  root["temperatura"] = temperatura;
  root["humedad"] = humedad;
  root["luz"] = luz;
  root["timestamp"] = millis();

  String jsonData;
  root.printTo(jsonData);

  if (enTiempoReal) {
      String url = "https://" + String(FIREBASE_HOST) + "/sensores.json";
      if (!sendHttpRequest("PUT", url, jsonData)) {
        guardarEnCola(jsonData);
      }
  } else {
      guardarEnCola(jsonData);
  }
}

void guardarEnCola(String data) {
  File file = LittleFS.open("/datalog.txt", "a");
  if (file) {
    file.println(data);
    file.close();
  }
}

void procesarColaOffline() {
  if (LittleFS.exists("/datalog.txt")) {
    File file = LittleFS.open("/datalog.txt", "r");
    String url = "https://" + String(FIREBASE_HOST) + "/historial.json";
    while(file.available()) {
      String line = file.readStringUntil('\n');
      if (line.length() > 0) {
        if (!sendHttpRequest("POST", url, line)) {
          file.close();
          return;
        }
      }
    }
    file.close();
    LittleFS.remove("/datalog.txt");
  }
}

void leerControlesFirebase() {
  if (modoOperacion != "manual") return;
  String url = "https://" + String(FIREBASE_HOST) + "/controls.json";
  String payload;
  if (getHttpRequest(url, payload)) {
    StaticJsonBuffer<200> jsonBuffer;
    JsonObject& root = jsonBuffer.parseObject(payload);
    if (!root.success()) return;
    digitalWrite(RELE_PIN, root["fan"].as<bool>() ? HIGH : LOW);
    digitalWrite(LED_PIN, root["lights"].as<bool>() ? HIGH : LOW);
    digitalWrite(BUZZER_PIN, root["alarm"].as<bool>() ? HIGH : LOW);
  }
}

bool getHttpRequest(String url, String& payload) {
    HTTPClient https;
    if (strlen(FIREBASE_AUTH) > 0) url += "?auth=" + String(FIREBASE_AUTH);
    if (https.begin(client, url)) {
        int httpCode = https.GET();
        if (httpCode == HTTP_CODE_OK) {
            payload = https.getString();
            https.end();
            return true;
        }
        https.end();
    }
    return false;
}

bool sendHttpRequest(String method, String url, String payload) {
  HTTPClient https;
  if (strlen(FIREBASE_AUTH) > 0) url += "?auth=" + String(FIREBASE_AUTH);
  if (https.begin(client, url)) {
    https.addHeader("Content-Type", "application/json");
    int httpCode = 0;
    if (method == "PUT") httpCode = https.PUT(payload);
    else if (method == "POST") httpCode = https.POST(payload);
    if (httpCode == HTTP_CODE_OK) {
        https.end();
        return true;
    }
    https.end();
  }
  return false;
}
